name: CD - Deploy to GKE

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_REGION: ${{ secrets.GCP_REGION }}
  ARTIFACT_REPO: ${{ secrets.ARTIFACT_REGISTRY_REPO }}
  IMAGE_NAME: iris-api

jobs:
  deploy:
    name: Build and Deploy to GKE
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1


    - name: Configure Docker Authentication
      run: |
        gcloud auth configure-docker ${{ env.GKE_REGION }}-docker.pkg.dev --quiet


    - name: Docker Login to Artifact Registry
      run: |
        gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin https://${{ env.GKE_REGION }}-docker.pkg.dev

    - name: Verify required files
      run: |
        echo "Checking required files..."
        ls -la
        if [ ! -f "model.joblib" ]; then
          echo "❌ model.joblib not found!"
          exit 1
        fi
        echo "✅ All files present"

    - name: Build Docker image
      run: |
        docker build -t ${{ env.GKE_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
        docker tag ${{ env.GKE_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
                   ${{ env.GKE_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:latest

    # UPDATED - Push with retry logic
    - name: Push to Artifact Registry
      run: |
        echo "Pushing image with SHA tag..."
        docker push ${{ env.GKE_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }} || {
          echo "First push attempt failed, retrying..."
          sleep 10
          docker push ${{ env.GKE_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        }
        
        echo "Pushing image with latest tag..."
        docker push ${{ env.GKE_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:latest || {
          echo "First push attempt failed, retrying..."
          sleep 10
          docker push ${{ env.GKE_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:latest
        }

    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} --region ${{ env.GKE_REGION }}

    - name: Deploy to GKE
      run: |
        cat <<EOF | kubectl apply -f -
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: iris-api-deployment
          labels:
            app: iris-api
        spec:
          replicas: 2
          selector:
            matchLabels:
              app: iris-api
          template:
            metadata:
              labels:
                app: iris-api
            spec:
              containers:
              - name: iris-api
                image: ${{ env.GKE_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
                ports:
                - containerPort: 8200
                resources:
                  requests:
                    memory: "128Mi"
                    cpu: "100m"
                  limits:
                    memory: "256Mi"
                    cpu: "200m"
                livenessProbe:
                  httpGet:
                    path: /health
                    port: 8200
                  initialDelaySeconds: 30
                  periodSeconds: 10
                readinessProbe:
                  httpGet:
                    path: /health
                    port: 8200
                  initialDelaySeconds: 10
                  periodSeconds: 5
        EOF

    - name: Expose service
      run: |
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: Service
        metadata:
          name: iris-api-service
        spec:
          type: LoadBalancer
          selector:
            app: iris-api
          ports:
            - protocol: TCP
              port: 80
              targetPort: 8200
        EOF

    - name: Wait for deployment
      run: |
        kubectl rollout status deployment/iris-api-deployment --timeout=5m
        echo "✅ Deployment complete"

    - name: Get service info
      run: |
        echo "=== Pods ==="
        kubectl get pods -l app=iris-api
        
        echo "=== Service ==="
        kubectl get service iris-api-service
        
        echo "Waiting for LoadBalancer IP..."
        sleep 60
        
        EXTERNAL_IP=$(kubectl get service iris-api-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        
        if [ -z "$EXTERNAL_IP" ]; then
          echo "⏳ LoadBalancer IP not ready yet"
        else
          echo "✅ API URL: http://$EXTERNAL_IP"
          echo "✅ API Docs: http://$EXTERNAL_IP/docs"
          echo "✅ Health Check: http://$EXTERNAL_IP/health"
        fi
